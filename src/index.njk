{% extends "layouts/base.njk" %}
{% block content %}
    <section class="hero">
        <figure class="hero-image">
            <img src="/images/uploads/remainoff-cover-image.jpg" alt="Remain Off hero image"/>
        </figure>
        <div class="hero-text">
            <h1 class="site-title">Remain Off</h1>
            <p class="site-subtitle">A quiet capsule of places, people, and reflections.</p>
        </div>
    </section>

    <section class="recent-entries">
        <h2 class="section-heading">Recent Reflections</h2>
        <ul class="entry-list">
            {% for entry in collections.entries %}
                <li class="entry-preview">
                    <a href="{{ entry.url }}">
                        {% if entry.data.image %}
                            <img src="{{ entry.data.image }}" alt="Image for {{ entry.data.title }}" class="entry-thumb"/>
                        {% endif %}
                        <h3 class="entry-title">{{ entry.data.title }}</h3>
                        <p class="entry-date">{{ entry.date | date("MMMM d, yyyy") }}</p>
                    </a>
                </li>
            {% endfor %}
        </ul>
    </section>

    <!-- Identity widget and CMS loader -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    <div id="cms" style="display: none;"></div>

    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.init();

        const hash = window.location.hash;

        // Process confirmation_token directly on homepage
        if (hash.includes("confirmation_token=")) {
          setTimeout(() => {
            window.netlifyIdentity.open("login");
            document.getElementById("cms").style.display = "block";
          }, 500);
        }

        // Redirect invite_token and recovery_token to /admin/
        if (hash.includes("invite_token=") || hash.includes("recovery_token=")) {
          window.location.replace("/admin/" + hash);
        }
      }
    </script>
{% endblock %}